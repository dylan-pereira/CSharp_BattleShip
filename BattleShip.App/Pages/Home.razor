@page "/"
@inject IGameService GameService
@inject GameState GameState
@inject HttpClient HttpClient

<PageTitle>BattleShip</PageTitle>
<img id="logo" src="images/battleship_logo.png" alt="logo" />
<div id="hudcontainer">
    <div id="hud">
        <div id="button-group">
            <button class="button" @onclick="StartNewGame">Nouvelle Partie</button>
            <button class="button" @onclick="RandomPlay">Jouer aléatoirement</button>
        </div>
        <div id="result" class="@(GameState.WinnerName != null ? "": "notshow")">

            <text> @GameState.WinnerName</text>&nbsp;a remporté la partie !
        </div>
    </div>
</div>

<div id="game" class="@(GameState.Id != Guid.Empty ? "": "notshow")">
    <div>
        <div class="stats">
            <h3>Joueur</h3>
            <div>
                Nombre de bateau détruits : <text> @GameState.GetNumberOfDestroyedShipPlayer() </text>/<text>
                    @GameState.GetTotalShipSize() </text>
            </div>
        </div>
        <table>
            @for (int i = 0; i < 10; i++)
            {
                <tr>
                    @for (int j = 0; j < 10; j++)
                    {
                        <td>
                            @if (GameState.PlayerShips != null)
                            {
                                @foreach (var ship in GameState.PlayerShips)
                                {
                                    if (ship.getFirstCoordinates().X == i && ship.getFirstCoordinates().Y == j)
                                    {
                                        <div style="position:relative" class=" @(ship.Horizontal ? "notHorizontal" : "" )"><img
                                                class=" @(ship.Horizontal ? "notHorizontalImage shipImage" : "shipImage" )"
                                                style="width: @(50 * ship.Size)px;" src="@ship.ImagePath" alt="Ship" />
                                        </div>
                                    }
                                }
                            }

                            @if (GameState.PlayerGrid[i, j] == 'X')
                            {
                                <img class="attackImage" src="images/hit.png" alt="Hit" />
                            }
                            else if (GameState.PlayerGrid[i, j] == 'O')
                            {
                                <img class="attackImage" src="images/miss.png" alt="Miss" />
                            }
                            else if (GameState.PlayerGrid[i, j] != '\0')
                            {
                                //TODO: delete this, il faut repositionner les bateaux
                                <text>.</text>

                            }
                        </td>

                    }

                </tr>
            }
        </table>
    </div>
    <div>
        <div class="stats">
            <h3>Adversaire</h3>
            <div>
                Nombre de bateau détruits : <text> @GameState.GetNumberOfDestroyedShipOpponent() </text>/<text>
                    @GameState.GetTotalShipSize() </text>
            </div>
        </div>
        <table>
            @for (int i = 0; i < 10; i++)
            {
                <tr>
                    @for (int j = 0; j < 10; j++)
                    {
                        int ii = i;
                        int jj = j;
                        <td class="clickable" @onclick="() => AttackOpponent(ii, jj)">
                            @if (GameState.OpponentGrid[i, j] == true)
                            {
                                <img src="images/hit.png" alt="Hit" />
                            }
                            else if (GameState.OpponentGrid[i, j] == false)
                            {
                                <img src="images/miss.png" alt="Miss" />
                            }
                        </td>
                    }
                </tr>
            }
        </table>
    </div>
</div>
@code {
    private async Task StartNewGame()
    {
        var gameData = await GameService.StartNewGame();
        if (gameData != null)
        {
            GameState.ResetGame();

            GameState.Id = gameData.gameId;

            GameState.PlayerShips = gameData.PlayerShips;
            if (GameState.PlayerShips != null)
            {
                foreach (var ship in GameState.PlayerShips)
                {
                    foreach (var coordinate in ship.Coordinates)
                    {
                        if (ship.Letter != null)
                            GameState.PlayerGrid[coordinate.X, coordinate.Y] = ship.Letter[0];
                    }
                }
                StateHasChanged();
            }
        }
    }

    private async void RandomPlay()
    {
        while (GameState.WinnerName == null)
        {
            Console.WriteLine(GameState.WinnerName);

            Random rand = new Random();
            int x = rand.Next(0, 10);
            int y = rand.Next(0, 10);
            await AttackOpponent(x, y);
        }
        StateHasChanged();
    }

    private async Task AttackOpponent(int x, int y)
    {
        if (GameState.OpponentGrid[x, y] == null && GameState.WinnerName == null)
        {
            var gameData = await GameService.AttackOpponent(GameState.Id, x, y);
            if (gameData != null)
            {

                if (gameData.PlayerAttackResponse == 'O')
                {
                    GameState.OpponentGrid[x, y] = false;
                }
                else if (gameData.PlayerAttackResponse == 'X')
                {
                    GameState.OpponentGrid[x, y] = true;
                }
                if (gameData.Winner != null)
                {
                    GameState.WinnerName = gameData.Winner;
                }
                if (gameData.OpponentAttackResponseToReplace != null && gameData.OpponentAttackResponseToReplace.AttackedCoordinates !=
                null)
                {
                    GameState.PlayerGrid[gameData.OpponentAttackResponseToReplace.AttackedCoordinates.X,
                    gameData.OpponentAttackResponseToReplace.AttackedCoordinates.Y] =
                    gameData.OpponentAttackResponseToReplace.AttackResult;
                }
                /*if (gameData.OpponentAttackCoordinates != null && gameData.OpponentAttackCoordinates.X != -1 &&
                gameData.OpponentAttackCoordinates.Y != -1)
                GameState.PlayerGrid[gameData.OpponentAttackCoordinates.X, gameData.OpponentAttackCoordinates.Y] =
                gameData.OpponentAttackResponse;*/
                StateHasChanged();
            }
        }
    }
}